{# map.html #}
{% extends "base.html" %}

{% block title %}Map Page{% endblock %}

{% block head %}
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <!-- Font Awesome for icons (Optional, if buttons use them) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Milsymbol JS (If needed by updateMap logic) -->
    <script src="https://unpkg.com/milsymbol/dist/milsymbol.js"></script>
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/planner.css') }}">

    <style>
        html, body { /* Ensure html/body take full height for flex */
            height: 100%;
            margin: 0;
            padding: 0;
            display: flex; /* Use flex on body */
            flex-direction: column;
        }
        #main-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            height: 100%;
            overflow: hidden;
            position: relative;
        }
        #map-wrapper {
            position: relative;
            flex-grow: 1;
            min-height: 200px;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        #button-bar {
            padding: 10px;
            flex-shrink: 0;
            background-color: #151515;
            border-top: 1px solid #333;
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 8px;
        }
        .btn { white-space: nowrap; }
        #task-sidebar {
            position: absolute;
            top: 0;
            right: 0;
            width: 340px;
            height: 100%;
            background: #1e1e1e;
            border-left: 1px solid #444;
            display: none;
            flex-direction: column;
            padding: 14px;
            gap: 12px;
            z-index: 500;
            box-shadow: -6px 0 12px rgba(0,0,0,0.45);
        }
        #task-sidebar.open { display: flex; }
        #task-sidebar h6 { margin: 0; }
        #task-sidebar .form-control,
        #task-sidebar .form-select {
            background: #111;
            color: #e5e5e5;
            border-color: #444;
        }
        #task-sidebar .tab-content { flex: 1; overflow-y: auto; padding-top: 6px; }
        .sidebar-tile {
            background: #111;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
        }
        .sidebar-tile .label {
            color: #8aa4af;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }
    </style>
{% endblock %}

{% block content %}
{# This container now fills the body thanks to flexbox on body and flex-grow here #}
<div id="main-container">
    <div id="map-wrapper">
        <div id="map"></div>
        <div id="task-sidebar" class="text-light">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="small text-secondary text-uppercase fw-semibold">Mission Planner</div>
                    <h6 class="text-info mb-0">Operations</h6>
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="closeTaskSidebar()">Close</button>
            </div>
            <ul class="nav nav-pills" id="taskSidebarTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="tasking-tab" data-bs-toggle="tab" data-bs-target="#tasking-pane" type="button" role="tab" aria-controls="tasking-pane" aria-selected="true">
                        Tasking
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="status-tab" data-bs-toggle="tab" data-bs-target="#status-pane" type="button" role="tab" aria-controls="status-pane" aria-selected="false">
                        Status
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="shapes-tab" data-bs-toggle="tab" data-bs-target="#shapes-pane" type="button" role="tab" aria-controls="shapes-pane" aria-selected="false">
                        Shapes
                    </button>
                </li>
            </ul>
            <div class="tab-content flex-grow-1" id="taskSidebarTabsContent">
                <div class="tab-pane fade show active" id="tasking-pane" role="tabpanel" aria-labelledby="tasking-tab">
                    <div class="small mb-2 text-secondary">Click a unit marker, pick a destination, then task.</div>
                    <div class="sidebar-tile">
                        <div class="label mb-1">Task Type</div>
                        <select id="task-type" class="form-select form-select-sm">
                            <option value="move">Move</option>
                            <option value="attack">Attack</option>
                            <option value="isr">ISR</option>
                            <option value="resupply">Resupply</option>
                            <option value="hold">Hold</option>
                        </select>
                    </div>
                    <div class="sidebar-tile">
                        <div class="label mb-1">Speed (km/h)</div>
                        <input id="task-speed" type="number" class="form-control form-control-sm" placeholder="Optional">
                    </div>
                    <div class="d-flex gap-2">
                        <button id="pick-task-point" type="button" class="btn btn-outline-info btn-sm flex-grow-1">Pick on map</button>
                        <button id="submit-task" type="button" class="btn btn-primary btn-sm flex-grow-1">Task</button>
                    </div>
                    <div class="d-flex gap-2">
                        <button id="cancel-task" type="button" class="btn btn-outline-danger btn-sm flex-grow-1">Cancel</button>
                    </div>
                </div>
                <div class="tab-pane fade" id="status-pane" role="tabpanel" aria-labelledby="status-tab">
                    <div class="sidebar-tile">
                        <div class="label">Selected Unit</div>
                        <div id="selected-unit-label" class="fw-semibold fs-6 text-info">None</div>
                    </div>
                    <div class="sidebar-tile">
                        <div class="label">Current Task</div>
                        <div id="current-task-label" class="fw-semibold fs-6">None</div>
                    </div>
                    <div class="sidebar-tile">
                        <div class="label">Destination</div>
                        <div id="task-destination-label" class="fw-semibold fs-6">None</div>
                    </div>
                </div>
                <div class="tab-pane fade" id="shapes-pane" role="tabpanel" aria-labelledby="shapes-tab">
                    <div class="sidebar-tile mb-2">
                        <div class="label">Shape Targeting</div>
                        <div class="small text-secondary mb-2">Select a drawn shape, then push it as a target or edit it via the modal.</div>
                        <div class="d-flex gap-2">
                            <button id="use-shape-target" type="button" class="btn btn-outline-info btn-sm flex-grow-1">Use shape</button>
                            <button type="button" class="btn btn-outline-light btn-sm flex-grow-1" data-bs-toggle="modal" data-bs-target="#shapeEditorModal">Edit</button>
                        </div>
                    </div>
                    <div class="small text-secondary">Drawing tools live in the map toolbar; saved shapes appear once selected on the map.</div>
                </div>
            </div>
        </div>
    </div>
    <div id="button-bar" class="btn-toolbar" role="toolbar">
        <button id="layers-btn" type="button" class="btn btn-primary"><i class="fas fa-layer-group"></i> Layers</button>
        <div class="btn-group me-2" role="group">
            <button id="draw-btn" type="button" class="btn btn-secondary"><i class="fas fa-draw-polygon"></i> Draw</button>
            <button id="measure-btn" type="button" class="btn btn-success"><i class="fas fa-ruler"></i> Measure</button>
            <button id="search-btn" type="button" class="btn btn-info"><i class="fas fa-search"></i> Search</button>
            <button id="route-btn" type="button" class="btn btn-warning"><i class="fas fa-route"></i> Route</button>
        </div>
        <div class="btn-group" role="group">
            <button id="clear-btn" type="button" class="btn btn-danger"><i class="fas fa-trash-alt"></i> Clear</button>
            <button id="save-btn" type="button" class="btn btn-dark"><i class="fas fa-save"></i> Save</button>
        </div>
        <div class="btn-group" role="group">
            <button id="toggle-task-sidebar" type="button" class="btn btn-outline-info"><i class="fas fa-tasks"></i> Tasking</button>
        </div>
    </div>
</div>

<!-- =================================================================== -->
<!-- Bootstrap Modal for Shape Editing (ADD THIS SECTION)                -->
<!-- =================================================================== -->
<div class="modal fade" id="shapeEditorModal" tabindex="-1" aria-labelledby="shapeEditorModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-light border-secondary">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title" id="shapeEditorModalLabel">Shape Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="shape-editor-form">
                    <div class="mb-3">
                        <label for="shape-category" class="form-label">Category</label>
                        <select id="shape-category" class="form-select bg-dark text-light border-secondary">
                            <option>Area of Interest</option>
                            <option>Exclusion Zone</option>
                            <option>Objective</option>
                            <option>Observation Post</option>
                            <option>Note</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="shape-description" class="form-label">Description</label>
                        <textarea id="shape-description" class="form-control bg-dark text-light border-secondary" rows="4" placeholder="Enter details..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="shape-color" class="form-label">Color</label>
                        <input type="color" id="shape-color" class="form-control form-control-color" value="#97009c">
                    </div>
                    <div class="mb-3">
                        <label for="shape-name" class="form-label">Display ID</label>
                        <input type="text" id="shape-name" class="form-control bg-dark text-light border-secondary" placeholder="e.g., OBJ-ALPHA">
                    </div>
                    <div class="mb-3">
                        <label for="shape-datetime" class="form-label">Date/Time</label>
                        <input type="datetime-local" id="shape-datetime" class="form-control bg-dark text-light border-secondary">
                    </div>
                </form>
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="save-shape-btn" class="btn btn-primary">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {# Load Leaflet and Draw first #}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

    {# Streaming client #}
    <script src="{{ url_for('static', filename='js/stream.js') }}"></script>

    {# Load map.js #}
    <script src="{{ url_for('static', filename='js/map.js') }}"></script>

    {# Add script to setup listeners specific to this page AFTER map.js runs its onload #}
    <script>
        // Ensure setupMapHtmlSpecificListeners (from map.js) is called.
        // It's already called inside the 'load' listener in map.js,
        // so no extra call might be needed here unless map.js changes again.
        // If map.js didn't call it reliably, you'd add:
        // document.addEventListener('DOMContentLoaded', () => {
        //    // Optional: Add a small delay if map init takes time
        //    setTimeout(setupMapHtmlSpecificListeners, 200);
        // });
        // For now, rely on the call within map.js's load listener.
    </script>
{% endblock %}
